<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TaskMaster Pro | Final Suite</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;700&display=swap');
        
        body { font-family: 'Plus Jakarta Sans', sans-serif; overflow: hidden; background: #f8fafc; }

        /* Glassmorphism Styles */
        .glass-sidebar {
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(15px);
            border-right: 1px solid rgba(255, 255, 255, 0.1);
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.5);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .glass-card:hover { transform: translateY(-4px); box-shadow: 0 12px 24px -10px rgba(0,0,0,0.1); }

        /* Side Drawer Animation */
        .drawer { transform: translateX(100%); transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
        .drawer.active { transform: translateX(0); }

        .subtask-done { text-decoration: line-through; color: #94a3b8; }
        
        #bg-canvas { position: fixed; top: 0; left: 0; z-index: -1; }

        .kanban-column { min-height: 70vh; }
        .ghost-card { opacity: 0.3; border: 2px dashed #3b82f6 !important; background: #eff6ff !important; }
    </style>
</head>
<body class="text-slate-800">

    <canvas id="bg-canvas"></canvas>

    <div class="flex h-screen w-full relative z-10">
        
        <aside class="w-64 glass-sidebar text-white flex flex-col">
            <div class="p-8">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-blue-600 rounded-xl flex items-center justify-center shadow-lg shadow-blue-500/40">
                        <i class="fas fa-bolt text-xl"></i>
                    </div>
                    <span class="text-xl font-bold tracking-tight">TaskMaster</span>
                </div>
            </div>

            <nav class="flex-1 px-4 space-y-2">
                <button onclick="switchTab('board')" class="w-full flex items-center gap-4 px-4 py-3 rounded-xl bg-blue-600 shadow-lg transition">
                    <i class="fas fa-th-large"></i> <span>Dashboard</span>
                </button>
                <button onclick="switchTab('analytics')" class="w-full flex items-center gap-4 px-4 py-3 rounded-xl hover:bg-white/10 transition text-slate-400 hover:text-white">
                    <i class="fas fa-chart-pie"></i> <span>Analytics</span>
                </button>
            </nav>

            <div class="p-6 border-t border-white/10">
                <div class="flex items-center gap-3 p-2 bg-white/5 rounded-2xl">
                    <img src="https://ui-avatars.com/api/?name=Dev+Machan&background=0D8ABC&color=fff" class="w-10 h-10 rounded-xl">
                    <div class="overflow-hidden">
                        <p class="text-sm font-semibold truncate">Dev Machan</p>
                        <p class="text-xs text-slate-400">Pro Member</p>
                    </div>
                </div>
            </div>
        </aside>

        <main class="flex-1 flex flex-col overflow-hidden">
            
            <header class="h-20 flex items-center justify-between px-8 bg-white/50 backdrop-blur-md border-b border-slate-200">
                <div>
                    <h2 id="view-title" class="text-2xl font-bold text-slate-800 tracking-tight">Project Board</h2>
                </div>
                
                <div class="flex items-center gap-4">
                    <button onclick="manualRefresh()" class="w-10 h-10 flex items-center justify-center bg-white border border-slate-200 rounded-2xl text-slate-400 hover:text-blue-600 transition-all shadow-sm">
                        <i id="sync-icon" class="fas fa-sync-alt"></i>
                    </button>

                    <button onclick="openCreateModal()" class="bg-slate-900 text-white px-6 py-2.5 rounded-2xl font-semibold hover:bg-slate-800 transition shadow-xl flex items-center gap-2">
                        <i class="fas fa-plus"></i> Add Task
                    </button>
                </div>
            </header>

            <div id="board-view" class="flex-1 p-8 overflow-x-auto">
                <div class="flex gap-8 h-full min-w-[1000px]">
                    <div class="w-80">
                        <div class="flex justify-between mb-4 px-2 font-bold text-slate-500 text-sm uppercase">To Do <span id="count-todo" class="bg-slate-200 px-2 rounded-md">0</span></div>
                        <div id="col-todo" data-status="todo" class="kanban-column space-y-4"></div>
                    </div>
                    <div class="w-80">
                        <div class="flex justify-between mb-4 px-2 font-bold text-blue-600 text-sm uppercase">In Progress <span id="count-doing" class="bg-blue-100 px-2 rounded-md">0</span></div>
                        <div id="col-doing" data-status="doing" class="kanban-column space-y-4"></div>
                    </div>
                    <div class="w-80">
                        <div class="flex justify-between mb-4 px-2 font-bold text-green-600 text-sm uppercase">Done <span id="count-done" class="bg-green-100 px-2 rounded-md">0</span></div>
                        <div id="col-done" data-status="done" class="kanban-column space-y-4"></div>
                    </div>
                </div>
            </div>

            <div id="analytics-view" class="hidden flex-1 p-10 overflow-y-auto">
                <div class="glass-card p-10 rounded-3xl h-[450px] max-w-4xl mx-auto">
                    <h3 class="font-bold text-lg mb-6">Task Performance</h3>
                    <canvas id="velocityChart"></canvas>
                </div>
            </div>
        </main>

        <div id="task-drawer" class="drawer fixed top-0 right-0 h-full w-full md:w-[450px] bg-white shadow-2xl z-50 flex flex-col">
            <div class="p-8 border-b flex justify-between items-center">
                <h3 class="text-xl font-bold">Task Details</h3>
                <button onclick="closeDrawer()" class="w-10 h-10 rounded-full hover:bg-slate-100 text-slate-400 transition">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="flex-1 p-8 space-y-6 overflow-y-auto">
                <div>
                    <label class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Title</label>
                    <input type="text" id="drawer-title" class="w-full mt-1 text-lg font-bold border-none focus:ring-0 p-0">
                </div>

                <div>
                    <label class="text-[10px] font-bold text-slate-400 uppercase tracking-widest block mb-2">Sub-tasks Progress</label>
                    <div class="w-full bg-slate-100 h-2 rounded-full mb-4">
                        <div id="drawer-progress-bar" class="bg-blue-600 h-2 rounded-full transition-all duration-500" style="width: 0%"></div>
                    </div>
                    
                    <div class="flex gap-2 mb-4">
                        <input type="text" id="new-subtask-input" class="flex-1 px-4 py-2 bg-slate-50 border border-slate-200 rounded-xl text-sm" placeholder="New sub-task...">
                        <button onclick="addSubtask()" class="bg-blue-600 text-white px-4 rounded-xl"><i class="fas fa-plus"></i></button>
                    </div>
                    <div id="subtask-list" class="space-y-2"></div>
                </div>
            </div>

            <div class="p-8 bg-slate-50 border-t">
                <button onclick="saveChanges()" class="w-full bg-blue-600 text-white py-4 rounded-2xl font-bold shadow-lg shadow-blue-500/20">Save Everything</button>
            </div>
        </div>
    </div>

    <div id="overlay" onclick="closeDrawer()" class="fixed inset-0 bg-slate-900/40 backdrop-blur-sm hidden z-40"></div>

    <script>
        // --- 1. DATA & INITIALIZATION ---
        let tasks = JSON.parse(localStorage.getItem('tm_tasks')) || [
            { id: 1, title: 'Build Landing Page', status: 'todo', subtasks: [{text: 'Design Header', done: true}, {text: 'Hero Section', done: false}] },
            { id: 2, title: 'Fix Login Bugs', status: 'doing', subtasks: [] }
        ];
        let currentEditingTaskId = null;

        // --- 2. THREE.JS BG ---
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ canvas: document.getElementById('bg-canvas'), alpha: true, antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        const geometry = new THREE.IcosahedronGeometry(15, 1);
        const material = new THREE.MeshNormalMaterial({ wireframe: true, transparent: true, opacity: 0.1 });
        const sphere = new THREE.Mesh(geometry, material);
        scene.add(sphere);
        camera.position.z = 40;
        function animate() { requestAnimationFrame(animate); sphere.rotation.y += 0.002; renderer.render(scene, camera); }
        animate();

        // --- 3. KANBAN LOGIC ---
        function renderTasks() {
            const cols = { todo: document.getElementById('col-todo'), doing: document.getElementById('col-doing'), done: document.getElementById('col-done') };
            Object.values(cols).forEach(c => c.innerHTML = '');

            tasks.forEach(task => {
                const total = task.subtasks ? task.subtasks.length : 0;
                const done = task.subtasks ? task.subtasks.filter(s => s.done).length : 0;
                const progress = total === 0 ? 0 : Math.round((done / total) * 100);

                const card = document.createElement('div');
                card.className = "glass-card p-5 rounded-2xl cursor-pointer relative group";
                card.setAttribute('data-id', task.id);
                card.onclick = () => openDrawer(task.id);
                card.innerHTML = `
                    <h4 class="font-bold text-slate-800 text-sm mb-2">${task.title}</h4>
                    <div class="flex items-center gap-2 text-[10px] text-slate-400 font-bold">
                        <i class="fas fa-tasks"></i> ${done}/${total} COMPLETED
                    </div>
                    <div class="w-full bg-slate-100 h-1 rounded-full mt-2">
                        <div class="bg-blue-500 h-1 rounded-full" style="width: ${progress}%"></div>
                    </div>
                `;
                cols[task.status].appendChild(card);
            });

            document.getElementById('count-todo').innerText = tasks.filter(t => t.status === 'todo').length;
            document.getElementById('count-doing').innerText = tasks.filter(t => t.status === 'doing').length;
            document.getElementById('count-done').innerText = tasks.filter(t => t.status === 'done').length;
            localStorage.setItem('tm_tasks', JSON.stringify(tasks));
        }

        // --- 4. SUB-TASK LOGIC ---
        function openDrawer(id) {
            currentEditingTaskId = id;
            const task = tasks.find(t => t.id == id);
            document.getElementById('drawer-title').value = task.title;
            renderSubtasks();
            document.getElementById('task-drawer').classList.add('active');
            document.getElementById('overlay').classList.remove('hidden');
        }

        function renderSubtasks() {
            const task = tasks.find(t => t.id == currentEditingTaskId);
            const list = document.getElementById('subtask-list');
            list.innerHTML = '';
            task.subtasks.forEach((sub, i) => {
                const div = document.createElement('div');
                div.className = "flex items-center gap-3 p-3 bg-slate-50 rounded-xl border border-slate-100";
                div.innerHTML = `
                    <input type="checkbox" ${sub.done ? 'checked' : ''} onchange="toggleSub(${i})" class="w-4 h-4 rounded text-blue-600">
                    <span class="text-sm flex-1 ${sub.done ? 'subtask-done' : ''}">${sub.text}</span>
                    <i onclick="delSub(${i})" class="fas fa-trash text-slate-300 hover:text-red-500 cursor-pointer text-xs"></i>
                `;
                list.appendChild(div);
            });
            const doneCount = task.subtasks.filter(s => s.done).length;
            const prog = task.subtasks.length === 0 ? 0 : (doneCount / task.subtasks.length) * 100;
            document.getElementById('drawer-progress-bar').style.width = prog + '%';
        }

        function addSubtask() {
            const input = document.getElementById('new-subtask-input');
            if(!input.value) return;
            const task = tasks.find(t => t.id == currentEditingTaskId);
            task.subtasks.push({text: input.value, done: false});
            input.value = '';
            renderSubtasks();
        }

        function toggleSub(i) {
            const task = tasks.find(t => t.id == currentEditingTaskId);
            task.subtasks[i].done = !task.subtasks[i].done;
            renderSubtasks();
        }

        function delSub(i) {
            const task = tasks.find(t => t.id == currentEditingTaskId);
            task.subtasks.splice(i, 1);
            renderSubtasks();
        }

        // --- 5. UI CONTROLS ---
        function closeDrawer() { 
            document.getElementById('task-drawer').classList.remove('active'); 
            document.getElementById('overlay').classList.add('hidden');
            renderTasks();
        }

        function manualRefresh() {
            const icon = document.getElementById('sync-icon');
            icon.classList.add('fa-spin');
            setTimeout(() => { renderTasks(); icon.classList.remove('fa-spin'); }, 800);
        }

        function saveChanges() {
            const task = tasks.find(t => t.id == currentEditingTaskId);
            task.title = document.getElementById('drawer-title').value;
            closeDrawer();
        }

        function switchTab(tab) {
            document.getElementById('board-view').classList.toggle('hidden', tab !== 'board');
            document.getElementById('analytics-view').classList.toggle('hidden', tab !== 'analytics');
            if(tab === 'analytics') initChart();
        }

        function openCreateModal() {
            const name = prompt("Task Name:");
            if(name) { tasks.push({id: Date.now(), title: name, status: 'todo', subtasks: []}); renderTasks(); }
        }

        // Drag & Drop
        ['col-todo', 'col-doing', 'col-done'].forEach(id => {
            new Sortable(document.getElementById(id), {
                group: 'kanban', animation: 150, ghostClass: 'ghost-card',
                onEnd: (e) => {
                    const task = tasks.find(t => t.id == e.item.getAttribute('data-id'));
                    task.status = e.to.getAttribute('data-status');
                    renderTasks();
                }
            });
        });

        function initChart() {
            const ctx = document.getElementById('velocityChart').getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: { labels: ['W1', 'W2', 'W3', 'W4'], datasets: [{ label: 'Completed', data: [5, 12, 8, 15], borderColor: '#3b82f6', tension: 0.4 }] },
                options: { maintainAspectRatio: false }
            });
        }

        renderTasks();
    </script>
</body>
</html>