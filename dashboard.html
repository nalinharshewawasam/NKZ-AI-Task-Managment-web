<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TaskMaster Ultra | Full Suite</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;700&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; overflow: hidden; background: #f1f5f9; }

        /* Glassmorphism Styles */
        .glass-sidebar { background: rgba(15, 23, 42, 0.98); backdrop-filter: blur(15px); border-right: 1px solid rgba(255, 255, 255, 0.1); }
        .glass-card { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.6); transition: all 0.3s ease; }
        .glass-card:hover { transform: translateY(-3px); box-shadow: 0 10px 20px rgba(0,0,0,0.05); }

        /* Drawer & Utils */
        .drawer { transform: translateX(100%); transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
        .drawer.active { transform: translateX(0); }
        .subtask-done { text-decoration: line-through; color: #94a3b8; }
        #bg-canvas { position: fixed; top: 0; left: 0; z-index: -1; }
        .kanban-column { min-height: 60vh; }
        .nav-active { background: #2563eb !important; color: white !important; box-shadow: 0 4px 12px rgba(37,99,235,0.3); }
    </style>
</head>
<body class="text-slate-800">

    <canvas id="bg-canvas"></canvas>

    <div class="flex h-screen w-full relative z-10">
        
        <aside class="w-64 glass-sidebar text-white flex flex-col">
            <div class="p-8 flex items-center gap-3">
                <div class="w-10 h-10 bg-blue-600 rounded-xl flex items-center justify-center shadow-lg"><i class="fas fa-bolt"></i></div>
                <span class="text-xl font-bold tracking-tight">TaskMaster</span>
            </div>

            <nav class="flex-1 px-4 space-y-2">
                <button onclick="switchTab('board')" id="btn-board" class="nav-btn w-full flex items-center gap-4 px-4 py-3 rounded-xl nav-active transition">
                    <i class="fas fa-th-large"></i> <span>Dashboard</span>
                </button>
                <button onclick="switchTab('calendar')" id="btn-calendar" class="nav-btn w-full flex items-center gap-4 px-4 py-3 rounded-xl hover:bg-white/10 text-slate-400 transition">
                    <i class="fas fa-calendar-alt"></i> <span>Calendar</span>
                </button>
                <button onclick="switchTab('analytics')" id="btn-analytics" class="nav-btn w-full flex items-center gap-4 px-4 py-3 rounded-xl hover:bg-white/10 text-slate-400 transition">
                    <i class="fas fa-chart-pie"></i> <span>Analytics</span>
                </button>
            </nav>

            <div class="p-6 border-t border-white/10">
                <div class="flex items-center gap-3 p-2 bg-white/5 rounded-2xl">
                    <img src="https://ui-avatars.com/api/?name=Admin&background=0D8ABC&color=fff" class="w-10 h-10 rounded-xl">
                    <div class="overflow-hidden"><p class="text-sm font-semibold truncate">Dev Machan</p></div>
                </div>
            </div>
        </aside>

        <main class="flex-1 flex flex-col overflow-hidden">
            
            <header class="h-20 flex items-center justify-between px-8 bg-white/60 border-b border-slate-200">
                <h2 id="view-title" class="text-2xl font-bold tracking-tight text-slate-800">Project Board</h2>
                <div class="flex items-center gap-4">
                    <button onclick="manualRefresh()" class="w-10 h-10 flex items-center justify-center bg-white border border-slate-200 rounded-2xl text-slate-400 hover:text-blue-600 transition shadow-sm">
                        <i id="sync-icon" class="fas fa-sync-alt"></i>
                    </button>
                    <button onclick="openCreateModal()" class="bg-slate-900 text-white px-6 py-2.5 rounded-2xl font-semibold hover:bg-slate-800 transition shadow-xl flex items-center gap-2">
                        <i class="fas fa-plus"></i> Add Task
                    </button>
                </div>
            </header>

            <div id="stats-bar" class="px-8 py-4 flex gap-6 bg-white/40 border-b border-slate-200">
                <div class="glass-card px-6 py-3 rounded-2xl flex items-center gap-4">
                    <div class="w-10 h-10 bg-indigo-100 text-indigo-600 rounded-xl flex items-center justify-center"><i class="fas fa-tasks"></i></div>
                    <div><p class="text-[10px] font-bold text-slate-400 uppercase">Total Tasks</p><h4 id="stat-total" class="text-xl font-bold">0</h4></div>
                </div>
                <div class="glass-card px-6 py-3 rounded-2xl flex items-center gap-4">
                    <div class="w-10 h-10 bg-green-100 text-green-600 rounded-xl flex items-center justify-center"><i class="fas fa-check-circle"></i></div>
                    <div><p class="text-[10px] font-bold text-slate-400 uppercase">Completed</p><h4 id="stat-done" class="text-xl font-bold">0</h4></div>
                </div>
            </div>

            <div id="board-view" class="flex-1 p-8 overflow-x-auto">
                <div class="flex gap-8 h-full min-w-[1000px]">
                    <div class="w-80">
                        <div class="flex justify-between mb-4 px-2 font-bold text-slate-500 text-xs uppercase">To Do <span id="count-todo" class="bg-slate-200 px-2 rounded">0</span></div>
                        <div id="col-todo" data-status="todo" class="kanban-column space-y-4"></div>
                    </div>
                    <div class="w-80">
                        <div class="flex justify-between mb-4 px-2 font-bold text-blue-600 text-xs uppercase">In Progress <span id="count-doing" class="bg-blue-100 px-2 rounded">0</span></div>
                        <div id="col-doing" data-status="doing" class="kanban-column space-y-4"></div>
                    </div>
                    <div class="w-80">
                        <div class="flex justify-between mb-4 px-2 font-bold text-green-600 text-xs uppercase">Done <span id="count-done-col" class="bg-green-100 px-2 rounded">0</span></div>
                        <div id="col-done" data-status="done" class="kanban-column space-y-4"></div>
                    </div>
                </div>
            </div>

            <div id="calendar-view" class="hidden flex-1 p-8 overflow-y-auto">
                <div class="max-w-4xl mx-auto glass-card rounded-3xl overflow-hidden">
                    <div class="p-6 border-b flex justify-between items-center bg-white/50">
                        <h3 id="current-month" class="text-xl font-bold">Month Year</h3>
                        <div class="flex gap-2">
                            <button onclick="changeMonth(-1)" class="p-2 hover:bg-white rounded-lg transition"><i class="fas fa-chevron-left"></i></button>
                            <button onclick="changeMonth(1)" class="p-2 hover:bg-white rounded-lg transition"><i class="fas fa-chevron-right"></i></button>
                        </div>
                    </div>
                    <div class="grid grid-cols-7 text-center font-bold text-slate-400 text-[10px] uppercase py-3 border-b">
                        <div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div>
                    </div>
                    <div id="calendar-grid" class="grid grid-cols-7 min-h-[400px]"></div>
                </div>
            </div>

            <div id="analytics-view" class="hidden flex-1 p-10">
                <div class="glass-card p-10 rounded-3xl h-[400px] max-w-4xl mx-auto">
                    <canvas id="velocityChart"></canvas>
                </div>
            </div>

        </main>

        <div id="task-drawer" class="drawer fixed top-0 right-0 h-full w-full md:w-[450px] bg-white shadow-2xl z-50 flex flex-col">
            <div class="p-8 border-b flex justify-between items-center">
                <h3 class="text-xl font-bold">Edit Task</h3>
                <button onclick="closeDrawer()" class="text-slate-400"><i class="fas fa-times"></i></button>
            </div>
            <div class="flex-1 p-8 space-y-6 overflow-y-auto">
                <div>
                    <label class="text-[10px] font-bold text-slate-400 uppercase">Task Title</label>
                    <input type="text" id="drawer-title" class="w-full mt-1 text-lg font-bold border-none p-0 focus:ring-0">
                </div>
                <div>
                    <label class="text-[10px] font-bold text-slate-400 uppercase">Sub-tasks Progress</label>
                    <div class="w-full bg-slate-100 h-2 rounded-full mt-2 mb-4">
                        <div id="drawer-progress-bar" class="bg-blue-600 h-2 rounded-full transition-all" style="width: 0%"></div>
                    </div>
                    <div class="flex gap-2 mb-4">
                        <input type="text" id="new-subtask-input" class="flex-1 px-4 py-2 bg-slate-50 border rounded-xl text-sm" placeholder="Add sub-task...">
                        <button onclick="addSubtask()" class="bg-blue-600 text-white px-4 rounded-xl"><i class="fas fa-plus"></i></button>
                    </div>
                    <div id="subtask-list" class="space-y-2"></div>
                </div>
            </div>
            <div class="p-8 border-t"><button onclick="closeDrawer()" class="w-full bg-blue-600 text-white py-4 rounded-2xl font-bold">Save & Close</button></div>
        </div>

    </div>

    <div id="overlay" onclick="closeDrawer()" class="fixed inset-0 bg-slate-900/40 backdrop-blur-sm hidden z-40"></div>

    <script>
        // --- 1. DATA ---
        let tasks = JSON.parse(localStorage.getItem('tm_tasks_ultra')) || [
            { id: 1, title: 'Welcome Task', status: 'todo', subtasks: [{text: 'Explore TaskMaster', done: true}] }
        ];
        let currentTaskId = null;
        let cMonth = new Date().getMonth();
        let cYear = new Date().getFullYear();

        // --- 2. THREE.JS BG ---
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ canvas: document.getElementById('bg-canvas'), alpha: true, antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        const sphere = new THREE.Mesh(new THREE.IcosahedronGeometry(15, 1), new THREE.MeshNormalMaterial({ wireframe: true, opacity: 0.05, transparent: true }));
        scene.add(sphere);
        camera.position.z = 40;
        function animate() { requestAnimationFrame(animate); sphere.rotation.y += 0.001; renderer.render(scene, camera); }
        animate();

        // --- 3. CORE FUNCTIONS ---
        function renderTasks() {
            const cols = { todo: document.getElementById('col-todo'), doing: document.getElementById('col-doing'), done: document.getElementById('col-done') };
            Object.values(cols).forEach(c => c.innerHTML = '');

            tasks.forEach(task => {
                const total = task.subtasks.length;
                const done = task.subtasks.filter(s => s.done).length;
                const prog = total === 0 ? 0 : Math.round((done / total) * 100);

                const card = document.createElement('div');
                card.className = "glass-card p-5 rounded-2xl cursor-pointer";
                card.setAttribute('data-id', task.id);
                card.onclick = () => openDrawer(task.id);
                card.innerHTML = `<h4 class="font-bold text-sm mb-2">${task.title}</h4>
                    <div class="flex justify-between text-[9px] font-bold text-slate-400 mb-1"><span>PROGESS</span><span>${prog}%</span></div>
                    <div class="w-full bg-slate-200 h-1 rounded-full"><div class="bg-blue-600 h-1 rounded-full" style="width: ${prog}%"></div></div>`;
                cols[task.status].appendChild(card);
            });
            updateStats();
            localStorage.setItem('tm_tasks_ultra', JSON.stringify(tasks));
        }

        function updateStats() {
            const doneTasks = tasks.filter(t => t.status === 'done').length;
            document.getElementById('stat-total').innerText = tasks.length;
            document.getElementById('stat-done').innerText = doneTasks;
            document.getElementById('count-todo').innerText = tasks.filter(t => t.status === 'todo').length;
            document.getElementById('count-doing').innerText = tasks.filter(t => t.status === 'doing').length;
            document.getElementById('count-done-col').innerText = doneTasks;
        }

        function manualRefresh() {
            const icon = document.getElementById('sync-icon');
            icon.classList.add('fa-spin');
            setTimeout(() => { renderTasks(); icon.classList.remove('fa-spin'); }, 800);
        }

        // --- 4. TABS & CALENDAR ---
        function switchTab(tab) {
            document.getElementById('board-view').classList.toggle('hidden', tab !== 'board');
            document.getElementById('calendar-view').classList.toggle('hidden', tab !== 'calendar');
            document.getElementById('analytics-view').classList.toggle('hidden', tab !== 'analytics');
            document.getElementById('stats-bar').classList.toggle('hidden', tab === 'analytics');
            
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('nav-active', 'text-white'));
            document.getElementById('btn-' + tab).classList.add('nav-active', 'text-white');
            
            if(tab === 'calendar') renderCalendar();
            if(tab === 'analytics') initChart();
        }

        function renderCalendar() {
            const grid = document.getElementById('calendar-grid');
            grid.innerHTML = '';
            const months = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
            document.getElementById('current-month').innerText = months[cMonth] + " " + cYear;

            const firstDay = new Date(cYear, cMonth, 1).getDay();
            const daysInMonth = new Date(cYear, cMonth + 1, 0).getDate();

            for (let i = 0; i < firstDay; i++) grid.innerHTML += `<div class="p-4 border border-slate-50 opacity-20"></div>`;
            for (let d = 1; d <= daysInMonth; d++) {
                const isToday = d === new Date().getDate() && cMonth === new Date().getMonth();
                grid.innerHTML += `<div class="p-4 border border-slate-50 h-20 hover:bg-blue-50 transition cursor-pointer">
                    <span class="${isToday ? 'bg-blue-600 text-white p-1.5 rounded-full' : ''} text-xs font-bold">${d}</span>
                </div>`;
            }
        }
        function changeMonth(dir) { cMonth += dir; if(cMonth<0){cMonth=11; cYear--;} if(cMonth>11){cMonth=0; cYear++;} renderCalendar(); }

        // --- 5. DRAWER & SUBTASKS ---
        function openDrawer(id) {
            currentTaskId = id;
            const task = tasks.find(t => t.id == id);
            document.getElementById('drawer-title').value = task.title;
            renderDrawerSubtasks();
            document.getElementById('task-drawer').classList.add('active');
            document.getElementById('overlay').classList.remove('hidden');
        }

        function closeDrawer() { 
            const task = tasks.find(t => t.id == currentTaskId);
            if(task) task.title = document.getElementById('drawer-title').value;
            document.getElementById('task-drawer').classList.remove('active'); 
            document.getElementById('overlay').classList.add('hidden');
            renderTasks();
        }

        function renderDrawerSubtasks() {
            const task = tasks.find(t => t.id == currentTaskId);
            const list = document.getElementById('subtask-list');
            list.innerHTML = '';
            task.subtasks.forEach((s, i) => {
                const div = document.createElement('div');
                div.className = "flex items-center gap-3 p-3 bg-slate-50 rounded-xl border";
                div.innerHTML = `<input type="checkbox" ${s.done ? 'checked' : ''} onchange="toggleSub(${i})" class="w-4 h-4 text-blue-600">
                    <span class="text-xs flex-1 ${s.done ? 'subtask-done' : ''}">${s.text}</span>
                    <i onclick="delSub(${i})" class="fas fa-trash text-slate-300 hover:text-red-400 cursor-pointer"></i>`;
                list.appendChild(div);
            });
            const prog = task.subtasks.length === 0 ? 0 : (task.subtasks.filter(s=>s.done).length / task.subtasks.length) * 100;
            document.getElementById('drawer-progress-bar').style.width = prog + '%';
        }

        function addSubtask() {
            const input = document.getElementById('new-subtask-input');
            if(!input.value) return;
            tasks.find(t => t.id == currentTaskId).subtasks.push({text: input.value, done: false});
            input.value = ''; renderDrawerSubtasks();
        }
        function toggleSub(i) { const t = tasks.find(t => t.id == currentTaskId); t.subtasks[i].done = !t.subtasks[i].done; renderDrawerSubtasks(); }
        function delSub(i) { tasks.find(t => t.id == currentTaskId).subtasks.splice(i, 1); renderDrawerSubtasks(); }

        function openCreateModal() {
            const name = prompt("Enter Task Title:");
            if(name) { tasks.push({id: Date.now(), title: name, status: 'todo', subtasks: []}); renderTasks(); }
        }

        // Drag & Drop
        ['col-todo', 'col-doing', 'col-done'].forEach(id => {
            new Sortable(document.getElementById(id), { group: 'kanban', animation: 150, onEnd: (e) => {
                const t = tasks.find(t => t.id == e.item.getAttribute('data-id'));
                t.status = e.to.getAttribute('data-status');
                renderTasks();
            }});
        });

        function initChart() {
            const ctx = document.getElementById('velocityChart').getContext('2d');
            new Chart(ctx, { type: 'line', data: { labels: ['W1', 'W2', 'W3', 'W4'], datasets: [{ label: 'Productivity', data: [10, 25, 15, 30], borderColor: '#2563eb', tension: 0.4 }] }, options: { maintainAspectRatio: false } });
        }

        renderTasks();
    </script>
</body>
</html>