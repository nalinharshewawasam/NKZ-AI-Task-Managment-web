<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TaskMaster Pro | Full Dashboard</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;700&display=swap');
        
        body { font-family: 'Plus Jakarta Sans', sans-serif; overflow: hidden; transition: all 0.3s; background: #f8fafc; }
        
        /* Glassmorphism & Themes */
        .glass-sidebar { background: rgba(15, 23, 42, 0.98); backdrop-filter: blur(15px); }
        .glass-card { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.6); transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .glass-card:hover { transform: translateY(-5px); box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); }

        /* Dark Mode Styling */
        .dark-mode { background-color: #0f172a !important; color: #f1f5f9; }
        .dark-mode .glass-card { background: rgba(30, 41, 59, 0.8); border-color: rgba(255,255,255,0.05); color: white; }
        .dark-mode header, .dark-mode #stats-bar { background: rgba(15, 23, 42, 0.8); border-color: rgba(255,255,255,0.1); }
        .dark-mode input { background: #1e293b; color: white; border-color: #334155; }

        .drawer { transform: translateX(100%); transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
        .drawer.active { transform: translateX(0); }
        #bg-canvas { position: fixed; top: 0; left: 0; z-index: -1; }
        .nav-active { background: #2563eb !important; color: white !important; }
        .subtask-done { text-decoration: line-through; color: #94a3b8; }
    </style>
</head>
<body class="text-slate-800">

    <canvas id="bg-canvas"></canvas>

    <div class="flex h-screen w-full relative z-10">
        
        <aside class="w-64 glass-sidebar text-white flex flex-col">
            <div class="p-8 flex items-center gap-3">
                <div class="w-10 h-10 bg-blue-600 rounded-xl flex items-center justify-center shadow-lg"><i class="fas fa-bolt"></i></div>
                <span class="text-xl font-bold tracking-tight">TaskMaster</span>
            </div>

            <nav class="flex-1 px-4 space-y-2">
                <button onclick="switchTab('board')" id="btn-board" class="nav-btn w-full flex items-center gap-4 px-4 py-3 rounded-xl nav-active transition">
                    <i class="fas fa-th-large"></i> <span>Dashboard</span>
                </button>
                <button onclick="switchTab('calendar')" id="btn-calendar" class="nav-btn w-full flex items-center gap-4 px-4 py-3 rounded-xl hover:bg-white/10 text-slate-400 transition">
                    <i class="fas fa-calendar-alt"></i> <span>Calendar</span>
                </button>
                <button onclick="switchTab('analytics')" id="btn-analytics" class="nav-btn w-full flex items-center gap-4 px-4 py-3 rounded-xl hover:bg-white/10 text-slate-400 transition">
                    <i class="fas fa-chart-pie"></i> <span>Analytics</span>
                </button>
            </nav>

            <div class="p-6 border-t border-white/10">
                <button onclick="logout()" class="w-full flex items-center gap-4 px-4 py-3 rounded-xl text-red-400 hover:bg-red-500/10 transition">
                    <i class="fas fa-sign-out-alt"></i> <span>Logout</span>
                </button>
            </div>
        </aside>

        <main class="flex-1 flex flex-col overflow-hidden">
            
            <header class="h-20 flex items-center justify-between px-8 bg-white/60 border-b border-slate-200">
                <h2 id="view-title" class="text-2xl font-bold">Project Board</h2>
                
                <div class="flex items-center gap-4">
                    <div class="relative hidden md:block">
                        <i class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-slate-400"></i>
                        <input type="text" id="taskSearch" onkeyup="filterTasks()" placeholder="Search tasks..." class="pl-11 pr-4 py-2 bg-white/80 border rounded-2xl outline-none focus:ring-2 focus:ring-blue-500 w-64 transition">
                    </div>

                    <button onclick="toggleTheme()" class="w-10 h-10 flex items-center justify-center bg-white border rounded-2xl text-slate-500 hover:text-yellow-500 transition shadow-sm">
                        <i id="theme-icon" class="fas fa-moon"></i>
                    </button>

                    <button onclick="manualRefresh()" class="w-10 h-10 flex items-center justify-center bg-white border rounded-2xl text-slate-400 hover:text-blue-600 shadow-sm transition">
                        <i id="sync-icon" class="fas fa-sync-alt"></i>
                    </button>

                    <button onclick="openCreateModal()" class="bg-slate-900 text-white px-6 py-2.5 rounded-2xl font-semibold shadow-xl flex items-center gap-2 hover:bg-slate-800 transition">
                        <i class="fas fa-plus"></i> Add Task
                    </button>
                </div>
            </header>

            <div id="stats-bar" class="px-8 py-4 flex gap-6 bg-white/40 border-b border-slate-200">
                <div class="glass-card px-6 py-3 rounded-2xl flex items-center gap-4 min-w-[180px]">
                    <div class="w-10 h-10 bg-blue-100 text-blue-600 rounded-xl flex items-center justify-center"><i class="fas fa-layer-group"></i></div>
                    <div><p class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">Total Tasks</p><h4 id="stat-total" class="text-xl font-bold">0</h4></div>
                </div>
                <div class="glass-card px-6 py-3 rounded-2xl flex items-center gap-4 min-w-[180px]">
                    <div class="w-10 h-10 bg-green-100 text-green-600 rounded-xl flex items-center justify-center"><i class="fas fa-check-double"></i></div>
                    <div><p class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">Completed</p><h4 id="stat-done" class="text-xl font-bold">0</h4></div>
                </div>
            </div>

            <div id="content-area" class="flex-1 overflow-hidden relative">
                <div id="board-view" class="absolute inset-0 p-8 overflow-x-auto">
                    <div class="flex gap-8 h-full min-w-[1000px]">
                        <div class="w-80">
                            <div class="flex justify-between mb-4 px-2 font-bold text-slate-400 text-xs uppercase tracking-widest">To Do <span id="count-todo" class="bg-slate-200 px-2 rounded">0</span></div>
                            <div id="col-todo" data-status="todo" class="kanban-column space-y-4 min-h-[500px]"></div>
                        </div>
                        <div class="w-80">
                            <div class="flex justify-between mb-4 px-2 font-bold text-blue-500 text-xs uppercase tracking-widest">In Progress <span id="count-doing" class="bg-blue-100 px-2 rounded">0</span></div>
                            <div id="col-doing" data-status="doing" class="kanban-column space-y-4 min-h-[500px]"></div>
                        </div>
                        <div class="w-80">
                            <div class="flex justify-between mb-4 px-2 font-bold text-green-500 text-xs uppercase tracking-widest">Done <span id="count-done-col" class="bg-green-100 px-2 rounded">0</span></div>
                            <div id="col-done" data-status="done" class="kanban-column space-y-4 min-h-[500px]"></div>
                        </div>
                    </div>
                </div>

                <div id="calendar-view" class="hidden absolute inset-0 p-8 overflow-y-auto">
                    <div class="max-w-4xl mx-auto glass-card rounded-3xl overflow-hidden shadow-2xl">
                        <div class="p-6 bg-white/50 border-b flex justify-between items-center">
                            <h3 id="current-month-year" class="text-xl font-bold"></h3>
                            <div class="flex gap-2">
                                <button onclick="changeMonth(-1)" class="p-2 hover:bg-white rounded-lg transition"><i class="fas fa-chevron-left"></i></button>
                                <button onclick="changeMonth(1)" class="p-2 hover:bg-white rounded-lg transition"><i class="fas fa-chevron-right"></i></button>
                            </div>
                        </div>
                        <div class="grid grid-cols-7 text-center font-bold text-slate-400 text-[10px] uppercase py-4 bg-slate-50/50">
                            <div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div>
                        </div>
                        <div id="calendar-grid" class="grid grid-cols-7 min-h-[400px]"></div>
                    </div>
                </div>

                <div id="analytics-view" class="hidden absolute inset-0 p-10 overflow-y-auto">
                    <div class="glass-card p-10 rounded-3xl h-[450px] max-w-4xl mx-auto">
                        <h3 class="font-bold mb-6">Efficiency Analytics</h3>
                        <canvas id="velocityChart"></canvas>
                    </div>
                </div>
            </div>
        </main>

        <div id="task-drawer" class="drawer fixed top-0 right-0 h-full w-full md:w-[450px] bg-white shadow-2xl z-50 flex flex-col">
            <div class="p-8 border-b flex justify-between items-center">
                <h3 class="text-xl font-bold">Task Management</h3>
                <button onclick="closeDrawer()" class="text-slate-400 hover:text-black transition"><i class="fas fa-times"></i></button>
            </div>
            <div class="flex-1 p-8 space-y-8 overflow-y-auto">
                <div>
                    <label class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Edit Title</label>
                    <input type="text" id="drawer-title" class="w-full mt-2 text-xl font-bold border-none p-0 focus:ring-0 bg-transparent">
                </div>
                <div>
                    <label class="text-[10px] font-bold text-slate-400 uppercase tracking-widest block mb-2">Checklist Progress</label>
                    <div class="w-full bg-slate-100 h-2 rounded-full mb-4">
                        <div id="drawer-progress-bar" class="bg-blue-600 h-2 rounded-full transition-all duration-500" style="width: 0%"></div>
                    </div>
                    <div class="flex gap-2 mb-4">
                        <input type="text" id="new-subtask-input" class="flex-1 px-4 py-2 bg-slate-50 border rounded-xl text-sm outline-none focus:border-blue-500" placeholder="Add a sub-task...">
                        <button onclick="addSubtask()" class="bg-blue-600 text-white px-4 rounded-xl hover:bg-blue-700 transition"><i class="fas fa-plus"></i></button>
                    </div>
                    <div id="subtask-list" class="space-y-3"></div>
                </div>
            </div>
            <div class="p-8 border-t bg-slate-50">
                <button onclick="closeDrawer()" class="w-full bg-blue-600 text-white py-4 rounded-2xl font-bold shadow-lg hover:bg-blue-700 transition">Confirm & Save</button>
            </div>
        </div>
    </div>

    <div id="overlay" onclick="closeDrawer()" class="fixed inset-0 bg-slate-900/40 backdrop-blur-sm hidden z-40"></div>

    <script>
        // --- GLOBAL STATE & STORAGE ---
        let tasks = JSON.parse(localStorage.getItem('tm_storage_v1')) || [
            { id: Date.now(), title: 'Start Planning Project', status: 'todo', subtasks: [], date: new Date().toISOString().split('T')[0] }
        ];
        let currentTaskId = null;
        let calDate = new Date();

        // --- BACKGROUND EFFECT ---
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ canvas: document.getElementById('bg-canvas'), alpha: true, antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        const sphere = new THREE.Mesh(new THREE.IcosahedronGeometry(15, 1), new THREE.MeshNormalMaterial({ wireframe: true, opacity: 0.05, transparent: true }));
        scene.add(sphere); camera.position.z = 40;
        function animate() { requestAnimationFrame(animate); sphere.rotation.y += 0.001; renderer.render(scene, camera); }
        animate();

        // --- TASK CORE LOGIC ---
        function renderTasks() {
            const cols = { todo: document.getElementById('col-todo'), doing: document.getElementById('col-doing'), done: document.getElementById('col-done') };
            Object.values(cols).forEach(c => c.innerHTML = '');

            tasks.forEach(task => {
                const doneCount = task.subtasks.filter(s => s.done).length;
                const progress = task.subtasks.length === 0 ? 0 : Math.round((doneCount / task.subtasks.length) * 100);

                const card = document.createElement('div');
                card.className = "glass-card p-5 rounded-2xl cursor-pointer";
                card.setAttribute('data-id', task.id);
                card.onclick = () => openDrawer(task.id);
                card.innerHTML = `
                    <h4 class="font-bold text-sm mb-3">${task.title}</h4>
                    <div class="flex justify-between text-[10px] font-bold text-slate-400 mb-2"><span>PROGRESS</span><span>${progress}%</span></div>
                    <div class="w-full bg-slate-200/50 h-1.5 rounded-full overflow-hidden"><div class="bg-blue-600 h-full transition-all" style="width: ${progress}%"></div></div>
                `;
                cols[task.status].appendChild(card);
            });
            updateStats();
            localStorage.setItem('tm_storage_v1', JSON.stringify(tasks));
        }

        function updateStats() {
            const doneTotal = tasks.filter(t => t.status === 'done').length;
            document.getElementById('stat-total').innerText = tasks.length;
            document.getElementById('stat-done').innerText = doneTotal;
            document.getElementById('count-todo').innerText = tasks.filter(t => t.status === 'todo').length;
            document.getElementById('count-doing').innerText = tasks.filter(t => t.status === 'doing').length;
            document.getElementById('count-done-col').innerText = doneTotal;
        }

        // --- TAB & THEME LOGIC ---
        function switchTab(tab) {
            document.getElementById('board-view').classList.toggle('hidden', tab !== 'board');
            document.getElementById('calendar-view').classList.toggle('hidden', tab !== 'calendar');
            document.getElementById('analytics-view').classList.toggle('hidden', tab !== 'analytics');
            document.getElementById('view-title').innerText = tab.charAt(0).toUpperCase() + tab.slice(1) + " View";
            
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('nav-active'));
            document.getElementById('btn-' + tab).classList.add('nav-active');
            
            if(tab === 'calendar') renderCalendar();
            if(tab === 'analytics') initChart();
        }

        function toggleTheme() {
            document.body.classList.toggle('dark-mode');
            const icon = document.getElementById('theme-icon');
            icon.classList.toggle('fa-moon'); icon.classList.toggle('fa-sun');
        }

        function filterTasks() {
            const query = document.getElementById('taskSearch').value.toLowerCase();
            document.querySelectorAll('.glass-card').forEach(card => {
                const title = card.querySelector('h4').innerText.toLowerCase();
                card.style.display = title.includes(query) ? "block" : "none";
            });
        }

        function logout() {
            if(confirm("Are you sure you want to logout?")) {
                window.location.href = 'login.html';
            }
        }

        // --- CALENDAR RENDER ---
        function renderCalendar() {
            const grid = document.getElementById('calendar-grid');
            grid.innerHTML = '';
            const m = calDate.getMonth(), y = calDate.getFullYear();
            const months = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
            document.getElementById('current-month-year').innerText = `${months[m]} ${y}`;

            const firstDay = new Date(y, m, 1).getDay();
            const daysInMonth = new Date(y, m + 1, 0).getDate();

            for (let i = 0; i < firstDay; i++) grid.innerHTML += `<div class="p-4 border border-slate-100/10 opacity-20"></div>`;
            for (let d = 1; d <= daysInMonth; d++) {
                const isToday = d === new Date().getDate() && m === new Date().getMonth();
                grid.innerHTML += `<div class="p-4 border border-slate-100/10 h-24 hover:bg-blue-500/5 transition cursor-pointer">
                    <span class="text-sm font-bold ${isToday ? 'bg-blue-600 text-white px-2 py-1 rounded-full' : ''}">${d}</span>
                </div>`;
            }
        }
        function changeMonth(dir) { calDate.setMonth(calDate.getMonth() + dir); renderCalendar(); }

        // --- DRAWER FUNCTIONS ---
        function openDrawer(id) {
            currentTaskId = id;
            const task = tasks.find(t => t.id == id);
            document.getElementById('drawer-title').value = task.title;
            renderSubtasks();
            document.getElementById('task-drawer').classList.add('active');
            document.getElementById('overlay').classList.remove('hidden');
        }
        function closeDrawer() { 
            const t = tasks.find(t => t.id == currentTaskId);
            if(t) t.title = document.getElementById('drawer-title').value;
            document.getElementById('task-drawer').classList.remove('active');
            document.getElementById('overlay').classList.add('hidden');
            renderTasks();
        }
        function renderSubtasks() {
            const task = tasks.find(t => t.id == currentTaskId);
            const list = document.getElementById('subtask-list'); list.innerHTML = '';
            task.subtasks.forEach((s, i) => {
                const div = document.createElement('div');
                div.className = "flex items-center gap-3 p-3 bg-slate-50 rounded-xl border border-slate-100";
                div.innerHTML = `<input type="checkbox" ${s.done ? 'checked' : ''} onchange="toggleSub(${i})" class="w-4 h-4 rounded text-blue-600">
                    <span class="text-sm flex-1 ${s.done ? 'subtask-done' : ''}">${s.text}</span>
                    <i onclick="delSub(${i})" class="fas fa-trash text-slate-300 hover:text-red-500 cursor-pointer text-xs"></i>`;
                list.appendChild(div);
            });
            const p = task.subtasks.length === 0 ? 0 : (task.subtasks.filter(s=>s.done).length / task.subtasks.length) * 100;
            document.getElementById('drawer-progress-bar').style.width = p + '%';
        }
        function addSubtask() {
            const inp = document.getElementById('new-subtask-input');
            if(!inp.value) return;
            tasks.find(t => t.id == currentTaskId).subtasks.push({text: inp.value, done: false});
            inp.value = ''; renderSubtasks();
        }
        function toggleSub(i) { tasks.find(t => t.id == currentTaskId).subtasks[i].done = !tasks.find(t => t.id == currentTaskId).subtasks[i].done; renderSubtasks(); }
        function delSub(i) { tasks.find(t => t.id == currentTaskId).subtasks.splice(i, 1); renderSubtasks(); }

        // --- DRAG & DROP ---
        ['col-todo', 'col-doing', 'col-done'].forEach(id => {
            new Sortable(document.getElementById(id), { group: 'kanban', animation: 150, onEnd: (e) => {
                const t = tasks.find(t => t.id == e.item.getAttribute('data-id'));
                t.status = e.to.getAttribute('data-status');
                renderTasks();
            }});
        });

        function manualRefresh() {
            document.getElementById('sync-icon').classList.add('fa-spin');
            setTimeout(() => { renderTasks(); document.getElementById('sync-icon').classList.remove('fa-spin'); }, 800);
        }

        function openCreateModal() {
            const name = prompt("Enter Task Title:");
            if(name) { tasks.push({id: Date.now(), title: name, status: 'todo', subtasks: [], date: new Date().toISOString().split('T')[0]}); renderTasks(); }
        }

        function initChart() {
            const ctx = document.getElementById('velocityChart').getContext('2d');
            if(window.myChart) window.myChart.destroy();
            window.myChart = new Chart(ctx, {
                type: 'line',
                data: { labels: ['W1', 'W2', 'W3', 'W4'], datasets: [{ label: 'Workload', data: [5, 12, 8, 15], borderColor: '#2563eb', tension: 0.4, fill: true, backgroundColor: 'rgba(37, 99, 235, 0.1)' }] },
                options: { maintainAspectRatio: false, plugins: { legend: { display: false } } }
            });
        }

        renderTasks();
    </script>
</body>
</html>
