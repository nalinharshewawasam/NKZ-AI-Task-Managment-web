<style>
    .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 100; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
    .modal-content { background: white; padding: 2rem; border-radius: 1.5rem; width: 100%; max-width: 400px; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); }
</style>

<div id="taskModal" class="modal">
    <div class="modal-content">
        <h3 class="text-xl font-bold mb-4 text-slate-800">New Task</h3>
        <div class="space-y-4">
            <input type="text" id="taskTitle" placeholder="What needs to be done?" class="w-full p-3 border rounded-xl outline-blue-500">
            <div class="grid grid-cols-2 gap-3">
                <input type="date" id="taskDate" class="p-3 border rounded-xl outline-blue-500 text-sm">
                <input type="time" id="taskTime" class="p-3 border rounded-xl outline-blue-500 text-sm">
            </div>
            <div class="flex gap-3 mt-6">
                <button onclick="closeModal()" class="flex-1 py-3 text-slate-500 font-bold hover:bg-slate-100 rounded-xl transition">Cancel</button>
                <button onclick="saveTask()" class="flex-1 py-3 bg-blue-600 text-white font-bold rounded-xl shadow-lg hover:bg-blue-700 transition">Save Task</button>
            </div>
        </div>
    </div>
</div>

<script type="module">
    // ... (Firebase Initialize කරන කොටස කලින් වගේමයි)

    // --- MODAL FUNCTIONS ---
    window.addTask = () => {
        document.getElementById('taskModal').style.display = 'flex';
    };

    window.closeModal = () => {
        document.getElementById('taskModal').style.display = 'none';
        document.getElementById('taskTitle').value = '';
    };

    // --- SAVE TO FIREBASE ---
    window.saveTask = async () => {
        const title = document.getElementById('taskTitle').value;
        const date = document.getElementById('taskDate').value;
        const time = document.getElementById('taskTime').value;

        if (title && date && time) {
            try {
                await addDoc(collection(db, "tasks"), {
                    title: title,
                    dueDate: date,
                    dueTime: time,
                    status: "todo",
                    userId: currentUser.uid,
                    createdAt: new Date().toISOString()
                });
                closeModal();
            } catch (e) { alert("Error: " + e.message); }
        } else {
            alert("Please fill all fields!");
        }
    };

    // --- RENDER TASKS (Update UI to show Date/Time) ---
    function listenForTasks() {
        const q = query(collection(db, "tasks"), where("userId", "==", currentUser.uid));
        onSnapshot(q, (snapshot) => {
            const cols = { todo: document.getElementById('col-todo'), doing: document.getElementById('col-doing'), done: document.getElementById('col-done') };
            Object.values(cols).forEach(c => c.innerHTML = '');

            snapshot.docs.forEach(d => {
                const data = d.data();
                const card = document.createElement('div');
                card.className = "glass-card p-5 rounded-2xl shadow-sm relative group mb-4";
                card.innerHTML = `
                    <p class="font-bold text-slate-800 mb-1">${data.title}</p>
                    <div class="flex items-center gap-2 text-[11px] text-slate-500 mb-4">
                        <i class="far fa-calendar-alt text-blue-500"></i> ${data.dueDate} 
                        <i class="far fa-clock text-blue-500 ml-2"></i> ${data.dueTime}
                    </div>
                    <div class="flex gap-2">
                        ${data.status === 'todo' ? `<button onclick="moveTask('${d.id}', 'doing')" class="text-[10px] bg-blue-50 text-blue-600 px-3 py-1 rounded-lg font-bold">Start</button>` : ''}
                        ${data.status === 'doing' ? `<button onclick="moveTask('${d.id}', 'done')" class="text-[10px] bg-green-50 text-green-600 px-3 py-1 rounded-lg font-bold">Done</button>` : ''}
                        <button onclick="deleteTask('${d.id}')" class="text-[10px] text-red-400 ml-auto group-hover:opacity-100 opacity-0 transition"><i class="fas fa-trash"></i></button>
                    </div>
                `;
                cols[data.status].appendChild(card);
            });
        });
    }
</script>
